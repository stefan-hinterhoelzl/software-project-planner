<div class="main-wrapper" *ngIf="this.view$ | async as view">
  <div class="viewpoint-button">
    <app-viewpoint-manager [viewpoints]="view[1]" [project]="view[0]"></app-viewpoint-manager>

    <span class="spacer"></span>

    <mat-icon color="accent" *ngIf="(loaded$ | async) && !treeLoading && !backlogLoading && !itemMoved"
      class="icon">cloud_done</mat-icon>
    <mat-icon color="warn" *ngIf="(loaded$ | async) && !treeLoading && !backlogLoading && itemMoved"
      class="icon">cloud_off</mat-icon>
    <button *ngIf=" (loaded$ | async) && !treeLoading && !backlogLoading"
      [matTooltipPosition]="'below'" matTooltip="Save the current hierachy and order to the server"
      [matTooltipShowDelay]="2000" mat-raised-button color="primary" (click)="saveRelations()" [disabled]="!itemMoved">
      <mat-icon>save</mat-icon> Save Hierarchy
    </button>
  </div>

  <div class="card-wrapper">
    <div class="row-wrapper" cdkDropListGroup>
      <div class="backlog">
        <div *ngIf="backlogLoading" class="issue-wrapper">
          <mat-spinner class="no-items"></mat-spinner>
        </div>
        <div *ngIf="(issuesBacklog$ | async) && !backlogLoading" class="issue-wrapper">

          <mat-card class="issue-list">
            <div style="display: flex; flex-direction: row; width: 100%; justify-content: space-between;">
              <h1 matCardTitle>Backlog</h1>
              <div [formGroup]="filterGroup" style="width: 50%">
                <mat-form-field style="width: 100%" subscriptSizing="dynamic" color="accent" appearance="fill">
                  <mat-label>Filter</mat-label>
                  <input #filter matInput placeholder="Filter Backlog Items..." formControlName="filterControl" />
                </mat-form-field>
              </div>
            </div>
            <mat-divider></mat-divider>
            <div class="adding-box" *ngIf="filteredBacklog.length === 0" [attr.data-id]="'backlog'">
              <h3>No Items in the Backlog</h3>
            </div>
            <div cdkDropList [cdkDropListData]="backlog" [id]="'backlog'" (cdkDropListDropped)="drop($event)"
              [cdkDropListSortingDisabled]="true">
              <div cdkDrag *ngFor="let node of filteredBacklog" cdkDrag [cdkDragData]="node.id"
                (cdkDragMoved)="dragMoved($event)" class="issue-list-item">
                <div class="node-item backlog-item" [attr.data-id]="node.id" [attr.id]="'node-' + node.id">
                  <p>{{ node.issue.title }}</p>
                </div>
              </div>
            </div>
          </mat-card>
        </div>
      </div>
      <div class="hierarchy">
        <div *ngIf="treeLoading" class="issue-wrapper">
          <mat-spinner class="no-items"></mat-spinner>
        </div>
        <div *ngIf="(issuesRelation$ | async) && !treeLoading" class="issue-wrapper">
          <mat-card class="issue-tree">
            <h1 style ="height: 56px;" matCardTitle>Hierarchy</h1>
            <mat-divider></mat-divider>
            <div *ngIf="treeData.length === 0" class="adding-box" [attr.data-id]="'main'">
              <h3>Drop First Item</h3>
            </div>
            <!-- Rendering for the tree -->
            <div cdkDropList [cdkDropListData]="treeData" [id]="'main'" (cdkDropListDropped)="drop($event)"
              [cdkDropListSortingDisabled]="true">
              <div *ngFor="let node of treeData" cdkDrag [cdkDragData]="node.id" (cdkDragMoved)="dragMoved($event)">
                <ng-container *ngTemplateOutlet="tmplNode; context: { node: node }"></ng-container>
              </div>
            </div>
          </mat-card>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Repeating template for the tree -->
<ng-template #tmplNode let-node="node">
  <div class="node-item" [attr.data-id]="node.id" [attr.id]="'node-' + node.id">
    <div class="node-title">
      <span *ngIf="node.children.length && !node.isExpanded" (click)="node.isExpanded = !node.isExpanded">
        <button mat-icon-button>
          <mat-icon>chevron_right</mat-icon>
        </button>
      </span>
      <span *ngIf="node.children.length && node.isExpanded" (click)="node.isExpanded = !node.isExpanded">
        <button mat-icon-button>
          <mat-icon>chevron_left</mat-icon>
        </button>
      </span>
      <span *ngIf="!node.children.length" style="margin-left: 48px"> </span>
      <div style="display: flex; flex-direction: row; width: 100%;">
        <div style="display: flex; flex-direction: column;">
          {{ node.issue.title }}
          <span class="item-notes"> {{ node.children.length }} {{ node.children.length === 1 ? 'Nested Item' : 'Nested
            Items' }} | {{node.issue.state}} </span>
        </div>

        <div class="spacer"></div>
        <!-- <mat-icon class = "icon-row">check_circle_outline</mat-icon> -->
        <!-- <mat-icon class = "icon-row">highlight_off</mat-icon> -->
        <mat-icon color="accent" class="icon-row">timeline</mat-icon>
        <div class="traffic-light-red"></div>

      </div>

    </div>

    <div *ngIf="node.isExpanded && node.children.length" class="node-children" cdkDropList
      [cdkDropListData]="node.children" [id]="node.id" (cdkDropListDropped)="drop($event)"
      [cdkDropListSortingDisabled]="true">
      <div *ngFor="let child of node.children" cdkDrag [cdkDragData]="child.id" (cdkDragMoved)="dragMoved($event)">
        <ng-container *ngTemplateOutlet="tmplNode; context: { node: child }"></ng-container>
      </div>
    </div>
  </div>
</ng-template>